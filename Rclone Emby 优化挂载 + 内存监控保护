#!/bin/bash
# Rclone Emby ä¼˜åŒ–æŒ‚è½½ + å†…å­˜ç›‘æ§ä¿æŠ¤
# åŠŸèƒ½ï¼š
# 1. æ­£å¸¸æŒ‚è½½ alist
# 2. è‡ªåŠ¨æ£€æµ‹ rclone å†…å­˜å ç”¨ï¼Œè¶…è¿‡é˜ˆå€¼æ—¶è‡ªåŠ¨ kill å¹¶é‡æŒ‚
# 3. å¢å¼ºé”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

MOUNT_POINT="/mnt/user/clouds/alist"
CACHE_DIR="/mnt/user/clouds/cache"
RCLONE_REMOTE="alist:/"
MEM_THRESHOLD=2048   # å†…å­˜é˜ˆå€¼ (MB)ï¼Œè¶…è¿‡å°±é‡å¯ rclone
MAX_RESTART_ATTEMPTS=3
LOG_FILE="/var/log/rclone_monitor.log"

# æ—¥å¿—å‡½æ•°
log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"
}

log_message "===== Rclone Emby æŒ‚è½½ + å†…å­˜ä¿æŠ¤å¯åŠ¨ ====="

# ---------------------------
# æ£€æŸ¥ rclone å†…å­˜å ç”¨ï¼ˆå¢å¼ºç‰ˆï¼‰
# ---------------------------
RCLONE_PID=$(pgrep -f "rclone.*alist")
if [[ -n "$RCLONE_PID" ]]; then
    # è·å–å†…å­˜å ç”¨ï¼ˆRSSï¼‰å’Œå†…å­˜ç™¾åˆ†æ¯”
    RCLONE_INFO=$(ps -o pid,rss,pmem,etime,cmd -p "$RCLONE_PID" --no-headers)
    RCLONE_MEM=$(echo "$RCLONE_INFO" | awk '{print $2}')
    RCLONE_MEM_MB=$((RCLONE_MEM / 1024))
    RCLONE_MEM_PERCENT=$(echo "$RCLONE_INFO" | awk '{print $3}')
    RCLONE_UPTIME=$(echo "$RCLONE_INFO" | awk '{print $4}')
    
    log_message "å‘ç°è¿è¡Œä¸­çš„rcloneè¿›ç¨‹: PID=$RCLONE_PID, å†…å­˜=${RCLONE_MEM_MB}MB (${RCLONE_MEM_PERCENT}%), è¿è¡Œæ—¶é—´=$RCLONE_UPTIME"
    
    if (( RCLONE_MEM_MB > MEM_THRESHOLD )); then
        log_message "âš ï¸ rcloneå†…å­˜è¶…è¿‡é˜ˆå€¼${MEM_THRESHOLD}MBï¼Œå‡†å¤‡é‡å¯è¿›ç¨‹"
        
        # è®°å½•é‡å¯å‰çš„çŠ¶æ€
        log_message "é‡å¯å‰è¿›ç¨‹çŠ¶æ€: $(ps -o pid,rss,pmem,etime,cmd -p $RCLONE_PID --no-headers)"
        
        # ä¼˜é›…å…³é—­
        log_message "å°è¯•ä¼˜é›…å…³é—­rcloneè¿›ç¨‹..."
        kill -TERM "$RCLONE_PID"
        sleep 10
        
        # æ£€æŸ¥æ˜¯å¦è¿˜åœ¨è¿è¡Œ
        if kill -0 "$RCLONE_PID" 2>/dev/null; then
            log_message "ä¼˜é›…å…³é—­å¤±è´¥ï¼Œå¼ºåˆ¶ç»ˆæ­¢è¿›ç¨‹"
            kill -9 "$RCLONE_PID"
        fi
        
        # å¼ºåˆ¶å¸è½½
        log_message "å¸è½½æŒ‚è½½ç‚¹..."
        umount -l "$MOUNT_POINT" 2>/dev/null || umount -f "$MOUNT_POINT" 2>/dev/null || true
        
        # ç­‰å¾…è¿›ç¨‹å®Œå…¨é€€å‡º
        sleep 5
        
        # æ¸…ç†å¯èƒ½çš„åƒµå°¸è¿›ç¨‹
        pkill -f "rclone.*alist" 2>/dev/null || true
        
        log_message "rcloneè¿›ç¨‹é‡å¯å®Œæˆï¼Œå‡†å¤‡é‡æ–°æŒ‚è½½"
    else
        log_message "âœ… rcloneå†…å­˜ä½¿ç”¨æ­£å¸¸ (${RCLONE_MEM_MB}MB < ${MEM_THRESHOLD}MB)"
        
        # æ£€æŸ¥æŒ‚è½½çŠ¶æ€
        if mount | grep -q "$MOUNT_POINT"; then
            log_message "âœ… æŒ‚è½½æ­£å¸¸ï¼Œç›‘æ§ä»»åŠ¡å®Œæˆ"
            exit 0
        else
            log_message "âš ï¸ å‘ç°rcloneè¿›ç¨‹è¿è¡Œä½†æœªæŒ‚è½½ï¼Œå‡†å¤‡é‡æ–°æŒ‚è½½"
        fi
    fi
else
    log_message "æœªå‘ç°è¿è¡Œä¸­çš„rcloneè¿›ç¨‹ï¼Œå‡†å¤‡å¯åŠ¨æŒ‚è½½"
fi

# ---------------------------
# ç¡®ä¿æŒ‚è½½ç‚¹å­˜åœ¨
# ---------------------------
mkdir -p "$MOUNT_POINT"
mkdir -p "$CACHE_DIR"

# ---------------------------
# æ ¹æ®ç£ç›˜ç©ºé—´åŠ¨æ€è®¾ç½®ç¼“å­˜å¤§å°
# ---------------------------
available_space=$(df "$CACHE_DIR" | awk 'NR==2 {print $4}')
available_gb=$((available_space / 1024 / 1024))

if [ $available_gb -gt 500 ]; then
    cache_size="200G"
elif [ $available_gb -gt 200 ]; then
    cache_size="100G"
elif [ $available_gb -gt 100 ]; then
    cache_size="50G"
else
    cache_size="20G"
fi

log_message "ç¼“å­˜ç›®å½•å¯ç”¨ç©ºé—´: ${available_gb}GBï¼Œè®¾ç½®ç¼“å­˜å¤§å°: $cache_size"

# ---------------------------
# æ£€æŸ¥å¹¶æ¸…ç†æ—§çš„æŒ‚è½½
# ---------------------------
if mount | grep -q "$MOUNT_POINT"; then
    log_message "å‘ç°å·²å­˜åœ¨çš„æŒ‚è½½ï¼Œå…ˆå¸è½½"
    umount -l "$MOUNT_POINT" 2>/dev/null || umount -f "$MOUNT_POINT" 2>/dev/null || true
    sleep 3
fi

# ---------------------------
# å¯åŠ¨rcloneæŒ‚è½½ï¼ˆä¼˜åŒ–å‚æ•°ï¼‰
# ---------------------------
log_message "ğŸ”„ å¼€å§‹æŒ‚è½½rclone..."

rclone mount "$RCLONE_REMOTE" "$MOUNT_POINT" \
    --use-mmap \
    --gid 100 --uid 99 \
    --umask 0000 \
    --default-permissions \
    --allow-other --allow-non-empty \
    \
    --buffer-size 256M \
    --transfers 8 \
    --checkers 16 \
    --low-level-retries 100 \
    --retries 5 \
    --timeout 300s \
    --contimeout 60s \
    \
    --vfs-cache-mode full \
    --vfs-cache-max-size $cache_size \
    --vfs-cache-max-age 24h \
    --vfs-read-ahead 512M \
    --vfs-read-chunk-size 128M \
    --vfs-read-chunk-size-limit 1G \
    --vfs-fast-fingerprint \
    --vfs-cache-poll-interval 60s \
    \
    --dir-cache-time 24h \
    --cache-dir="$CACHE_DIR" \
    \
    --no-modtime \
    --no-checksum \
    --multi-thread-streams 4 \
    --multi-thread-cutoff 50M \
    \
    --log-level ERROR \
    --log-file "/var/log/rclone.log" \
    --daemon

# ---------------------------
# éªŒè¯æŒ‚è½½ç»“æœ
# ---------------------------
sleep 8

# å¤šæ¬¡æ£€æŸ¥æŒ‚è½½çŠ¶æ€
for i in {1..5}; do
    if mount | grep -q "$MOUNT_POINT"; then
        NEW_PID=$(pgrep -f "rclone.*alist")
        log_message "âœ… æŒ‚è½½æˆåŠŸï¼æ–°çš„rcloneè¿›ç¨‹PID: $NEW_PID"
        
        # æ˜¾ç¤ºæ–°è¿›ç¨‹çš„åˆå§‹çŠ¶æ€
        if [[ -n "$NEW_PID" ]]; then
            sleep 2
            NEW_MEM_INFO=$(ps -o pid,rss,pmem -p "$NEW_PID" --no-headers)
            NEW_MEM_MB=$(echo "$NEW_MEM_INFO" | awk '{print int($2/1024)}')
            log_message "æ–°è¿›ç¨‹åˆå§‹å†…å­˜å ç”¨: ${NEW_MEM_MB}MB"
        fi
        
        log_message "===== æŒ‚è½½ç›‘æ§å®Œæˆ ====="
        exit 0
    else
        log_message "æŒ‚è½½æ£€æŸ¥ç¬¬${i}æ¬¡å¤±è´¥ï¼Œç­‰å¾…é‡è¯•..."
        sleep 3
    fi
done

log_message "âŒ æŒ‚è½½å¤±è´¥ï¼è¯·æ£€æŸ¥é…ç½®å’Œç½‘ç»œè¿æ¥"
log_message "æœ€åçš„rcloneæ—¥å¿—:"
tail -10 /var/log/rclone.log 2>/dev/null | while read line; do
    log_message "RCLONE: $line"
done

exit 1
